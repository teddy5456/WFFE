<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaigns | WFFE Connect</title>
    <link rel="stylesheet" href="/dashboard/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Epilogue:wght@700;800&display=swap" rel="stylesheet">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
</script>
<script src="/dashboard/dashboard.js"></script>
<script type="text/javascript">
   (function(){
      emailjs.init({
        publicKey: "cy9YL054A1rcf2BH4",
      });
   })();
</script>
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo" >
                    <a href="/products/product-landing.html"><i class="fas fa-couch"></i></a>
                    <span>WFFE Connect</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-title">Main</div>
                    <ul>
                        <li class="active">
                            <a href="/dashboard/campaigns/index.html">
                                <i class="fas fa-bullhorn"></i>
                                <span>Campaigns</span>
                                <span class="badge" id="campaignCount">0</span>
                            </a>
                        </li>
                        <li>
                            <a href="/dashboard/campaigns/products/products.html">
                                <i class="fas fa-shopping-cart"></i>
                                <span>Products</span>
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fas fa-users"></i>
                                <span>Customers</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Analytics</div>
                    <ul>
                        <li>
                            <a href="#">
                                <i class="fas fa-chart-line"></i>
                                <span>Performance</span>
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fas fa-search-dollar"></i>
                                <span>ROI Tracker</span>
                            </a>
                        </li>
                        <li>
                            <a href="/dashboard/reports.html">
                                <i class="fas fa-poll"></i>
                                <span>Reports</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Settings</div>
                    <ul>
                        <li>
                            <a href="#">
                                <i class="fas fa-cog"></i>
                                <span>Account</span>
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fas fa-bell"></i>
                                <span>Notifications</span>
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fas fa-question-circle"></i>
                                <span>Help Center</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="avatar">
                        <img src="https://randomuser.me/api/portraits/women/45.jpg" alt="User">
                    </div>
                    <div class="user-info">
                        <div class="name">Sarah Johnson</div>
                        <div class="role">Marketing Manager</div>
                    </div>
                    <button class="user-menu">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Top Navigation Bar -->
            <header class="topbar">
                <div class="topbar-left">
                    <h1>Campaigns</h1>
                    <div class="breadcrumb">
                        <a href="#">Home</a>
                        <span>/</span>
                        <a href="#">Marketing</a>
                        <span>/</span>
                        <a href="#">Campaigns</a>
                    </div>
                </div>
                
                <div class="topbar-right">
                    <div class="campaign-type-tabs">
                        <button class="tab-btn active" data-type="all">All Campaigns</button>
                        <button class="tab-btn" data-type="email">Email</button>
                        <button class="tab-btn" data-type="social">Social</button>
                        <button class="tab-btn" data-type="paid">Paid Ads</button>
                    </div>
                    
                    <button class="quick-action-btn" id="newCampaignBtn">
                        <i class="fas fa-plus"></i>
                        <span>New Campaign</span>
                    </button>
                </div>
            </header>
            
            <!-- Campaigns Content -->
            <div class="content-wrapper">
                <!-- Campaign View Selector -->
                <div class="view-selector">
                    <button class="view-btn active" data-view="grid">
                        <i class="fas fa-th-large"></i>
                        <span>Grid View</span>
                    </button>
                    <button class="view-btn" data-view="table">
                        <i class="fas fa-table"></i>
                        <span>Table View</span>
                    </button>
                    <button class="view-btn" data-view="analytics">
                        <i class="fas fa-chart-pie"></i>
                        <span>Analytics</span>
                    </button>
                </div>
                
                <!-- Campaign Filters -->
                <div class="campaign-filters">
                    <div class="filter-group">
                        <label>Status:</label>
                        <select class="filter-select" id="statusFilter">
                            <option value="all">All</option>
                            <option value="draft">Draft</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Date Range:</label>
                        <select class="filter-select" id="dateFilter">
                            <option>Last 30 days</option>
                            <option>Last 90 days</option>
                            <option>This year</option>
                            <option>Custom range</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Sort By:</label>
                        <select class="filter-select" id="sortFilter">
                            <option>Newest first</option>
                            <option>Oldest first</option>
                            <option>Highest engagement</option>
                            <option>Highest ROI</option>
                        </select>
                    </div>
                    
                    <button class="filter-btn" id="applyFilters">
                        <i class="fas fa-filter"></i>
                        <span>Apply Filters</span>
                    </button>
                </div>
                
                <!-- Grid View (Default) -->
                <div class="campaign-grid-view" id="gridView">
                    <div class="campaign-grid" id="campaignGrid">
                        <!-- Campaign cards will be loaded here dynamically -->
                        <div class="campaign-card loading">
                            <div class="loading-spinner"></div>
                            <p>Loading campaigns...</p>
                        </div>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination">
                        <button class="pagination-btn disabled">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="pagination-btn active">1</button>
                        <button class="pagination-btn">2</button>
                        <button class="pagination-btn">3</button>
                        <button class="pagination-btn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Table View (Hidden by default) -->
                <div class="campaign-table-view" id="tableView" style="display: none;">
                    <div class="campaigns-table-container">
                        <table class="campaigns-table">
                            <thead>
                                <tr>
                                    <th>Campaign Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Impressions</th>
                                    <th>Engagement</th>
                                    <th>Revenue</th>
                                    <th>Start Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="campaignTableBody">
                                <!-- Table rows will be loaded here dynamically -->
                                <tr>
                                    <td colspan="8" class="loading-row">
                                        <div class="loading-spinner"></div>
                                        <p>Loading campaigns...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- Pagination -->
                        <div class="pagination">
                            <button class="pagination-btn disabled">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="pagination-btn active">1</button>
                            <button class="pagination-btn">2</button>
                            <button class="pagination-btn">3</button>
                            <button class="pagination-btn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics View (Hidden by default) -->
                <div class="campaign-analytics-view" id="analyticsView" style="display: none;">
                    <div class="analytics-header">
                        <h2>Campaign Performance Overview</h2>
                        <div class="time-selector">
                            <select class="filter-select" id="analyticsTimeRange">
                                <option>Last 30 days</option>
                                <option>Last 90 days</option>
                                <option>This year</option>
                                <option>Custom range</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background-color: #FFEE58;">
                                <i class="fas fa-bullhorn" style="color: #FBC02D;"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="totalCampaigns">0</div>
                                <div class="stat-label">Total Campaigns</div>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i> <span id="campaignTrend">0%</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background-color: #B3E5FC;">
                                <i class="fas fa-envelope-open" style="color: #03A9F4;"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="avgOpenRate">0%</div>
                                <div class="stat-label">Avg Open Rate</div>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i> <span id="openRateTrend">0%</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background-color: #C8E6C9;">
                                <i class="fas fa-mouse-pointer" style="color: #4CAF50;"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="avgClickRate">0%</div>
                                <div class="stat-label">Avg Click Rate</div>
                            </div>
                            <div class="stat-trend down">
                                <i class="fas fa-arrow-down"></i> <span id="clickRateTrend">0%</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon" style="background-color: #FFCDD2;">
                                <i class="fas fa-dollar-sign" style="color: #F44336;"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="totalRevenue">$0</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i> <span id="revenueTrend">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Charts -->
                    <div class="charts-row">
                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Campaign Performance Over Time</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Campaign Type Distribution</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="typeChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Performing Campaigns -->
                    <div class="content-card">
                        <div class="card-header">
                            <h3>Top Performing Campaigns</h3>
                            <div class="card-actions">
                                <select class="filter-select" id="topCampaignsFilter">
                                    <option>Last 30 days</option>
                                    <option>Last 90 days</option>
                                    <option>This year</option>
                                </select>
                            </div>
                        </div>
                        <div class="top-campaigns-list" id="topCampaignsList">
                            <!-- Top campaigns will be loaded here dynamically -->
                            <div class="loading-spinner"></div>
                            <p>Loading top campaigns...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- New Campaign Modal -->
    <div class="modal-overlay" id="newCampaignModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3>Create New Campaign</h3>
                <button class="modal-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="campaign-type-selector">
                    <div class="type-option" data-type="email">
                        <div class="type-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <h4>Email Campaign</h4>
                        <p>Send targeted emails to your customers</p>
                    </div>
                    
                    <div class="type-option" data-type="social_media">
                        <div class="type-icon">
                            <i class="fas fa-share-alt"></i>
                        </div>
                        <h4>Social Media</h4>
                        <p>Create posts for social platforms</p>
                    </div>
                    
                    <div class="type-option" data-type="in_app_ad">
                        <div class="type-icon">
                            <i class="fas fa-ad"></i>
                        </div>
                        <h4>In-App Ads</h4>
                        <p>Run advertising within your app</p>
                    </div>
                </div>
                
                <!-- Email Campaign Form (hidden by default) -->
                <div class="campaign-form" id="emailCampaignForm" style="display: none;">
                    <div class="form-step active" data-step="1">
                        <h4>Campaign Details</h4>
                        <div class="form-group">
                            <label for="emailCampaignName" class="required">Campaign Name</label>
                            <input type="text" id="emailCampaignName" placeholder="e.g. Summer Sale 2023" required>
                            <div class="error-message">Please enter a campaign name</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="emailDescription">Description</label>
                            <textarea id="emailDescription" rows="3" placeholder="Brief description of the campaign"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="emailSubject" class="required">Email Subject</label>
                            <input type="text" id="emailSubject" placeholder="e.g. Don't miss our summer sale!" required>
                            <div class="error-message">Please enter an email subject</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="emailSenderName" class="required">Sender Name</label>
                            <input type="text" id="emailSenderName" placeholder="e.g. Marketing Team" required>
                            <div class="error-message">Please enter a sender name</div>
                        </div>

                        <div class="form-actions">
                            <button class="btn secondary cancel-btn">Cancel</button>
                            <button class="btn primary next-btn" data-next="2">Next: Audience</button>
                        </div>
                    </div>
                    
                    <div class="form-step" data-step="2">
                        <h4>Audience Selection</h4>
                        
                        <div class="form-group">
                            <label for="emailAudience" class="required">Target Audience</label>
                            <select id="emailAudience" required>
                                <option value="">Select audience</option>
                                <option value="all">All Customers</option>
                                <option value="recent">Recent Purchasers</option>
                                <option value="inactive">Inactive Customers</option>
                                <option value="custom">Custom Segment</option>
                            </select>
                            <div class="error-message">Please select an audience</div>
                        </div>

                        <div class="form-group" id="customRecipientsGroup" style="display: none;">
                            <label class="required">Select Recipients</label>
                            <div class="recipient-selection">
                                <div class="recipient-search">
                                    <input type="text" id="recipientSearch" placeholder="Search recipients...">
                                    <button type="button" id="selectAllBtn">Select All</button>
                                    <button type="button" id="deselectAllBtn">Deselect All</button>
                                </div>
                                <div class="recipients-list-container">
                                    <div class="recipients-list" id="recipientsList">
                                        <!-- Recipients will be loaded here -->
                                        <div class="loading-spinner"></div>
                                        <p>Loading recipients...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="recipient-count">
                                <span id="selectedRecipientCount">0</span> recipients selected
                                <span id="invalidEmailsCount" style="display: none;"> (<span>0</span> invalid emails)</span>
                            </div>
                            <div class="error-message">Please select at least one recipient</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="emailRecipientCount">Estimated Recipient Count</label>
                            <input type="number" id="emailRecipientCount" placeholder="Estimated number of recipients" readonly>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn secondary back-btn" data-back="1">Back</button>
                            <button class="btn primary next-btn" data-next="3">Next: Design Email</button>
                        </div>
                    </div>
                    
                    <div class="form-step" data-step="3">
                        <h4>Email Design</h4>
                        <div class="form-group">
                            <label class="required">Email Template</label>
                            <div class="template-selector">
                                <div class="template-option active">
                                    <div class="template-preview">
                                        <img src="../../../assets/images/email-template1.jpg" alt="Template 1">
                                    </div>
                                    <div class="template-name">Summer Sale</div>
                                </div>
                                
                                <div class="template-option">
                                    <div class="template-preview">
                                        <img src="../../../assets/images/email-template2.jpg" alt="Template 2">
                                    </div>
                                    <div class="template-name">New Arrivals</div>
                                </div>
                                
                                <div class="template-option">
                                    <div class="template-preview">
                                        <img src="../../../assets/images/email-template3.jpg" alt="Template 3">
                                    </div>
                                    <div class="template-name">Promotional</div>
                                </div>
                            </div>
                            <div class="error-message">Please select a template</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Email Content</label>
                            <div id="emailEditor" style="height: 300px"></div>
                            <div class="error-message">Please enter email content</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="emailTemplateId">Template ID</label>
                            <input type="number" id="emailTemplateId" placeholder="Enter template ID if applicable">
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn secondary back-btn" data-back="2">Back</button>
                            <button class="btn primary next-btn" data-next="4">Next: Schedule</button>
                        </div>
                    </div>
                    
                    <div class="form-step" data-step="4">
                        <h4>Schedule & Status</h4>
                        
                        <div class="form-group">
                            <label for="emailStatus" class="required">Status</label>
                            <select id="emailStatus" required>
                                <option value="draft">Draft</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="active">Active</option>
                            </select>
                            <div class="error-message">Please select a status</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="emailSchedule" class="required">Schedule</label>
                            <select id="emailSchedule" required>
                                <option value="now">Send immediately</option>
                                <option value="scheduled">Schedule for later</option>
                                <option value="draft">Save as draft</option>
                            </select>
                            <div class="error-message">Please select a schedule option</div>
                            
                            <div class="form-group schedule-datetime" id="scheduleDateTime" style="display: none;">
                                <label for="emailSendTime" class="required">Send Date & Time</label>
                                <input type="datetime-local" id="emailSendTime" required>
                                <div class="error-message">Please select a date and time</div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn secondary back-btn" data-back="3">Back</button>
                            <button onclick="sendCampaignEmails()" class="btn primary next-btn" data-next="5">Next: Review</button>
                        </div>
                    </div>
                    
                    <div class="form-step" data-step="5">
                        <h4>Review & Send</h4>
                        <div class="review-section">
                            <div class="review-item">
                                <label>Campaign Name:</label>
                                <span id="reviewCampaignName">-</span>
                            </div>
                            <div class="review-item">
                                <label>Description:</label>
                                <span id="reviewDescription">-</span>
                            </div>
                            <div class="review-item">
                                <label>Subject:</label>
                                <span id="reviewSubject">-</span>
                            </div>
                            <div class="review-item">
                                <label>Audience:</label>
                                <span id="reviewAudience">-</span>
                            </div>
                            <div class="review-item">
                                <label>Recipients:</label>
                                <div class="recipients-preview" id="reviewRecipients"></div>
                            </div>
                            <div class="review-item">
                                <label>Sender:</label>
                                <span id="reviewSender">-</span>
                            </div>
                            <div class="review-item">
                                <label>Status:</label>
                                <span id="reviewStatus">-</span>
                            </div>
                            <div class="review-item">
                                <label>Schedule:</label>
                                <span id="reviewSchedule">-</span>
                            </div>
                        </div>
                        
                        <div class="preview-section">
                            <h5>Email Preview</h5>
                            <div class="email-preview">
                                <div class="email-preview-header">
                                    <div class="email-subject" id="previewSubject">Your Email Subject Here</div>
                                    <div class="email-sender">From: <span id="previewSender">WFFE Connect</span> &lt;hello@wffeconnect.com&gt;</div>
                                </div>
                                <div class="email-preview-body" id="emailPreviewContent">
                                    <img src="../../../assets/images/email-template-preview.jpg" alt="Email Preview">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn secondary back-btn" data-back="4">Back</button>
                            <button  class="btn primary send-btn" id="sendEmailCampaign">
                                <span class="btn-text">Send Campaign</span>
                                <span class="btn-loading" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i> Sending...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Social Campaign Form (hidden by default) -->
                <div class="campaign-form" id="socialCampaignForm" style="display: none;">
                    <!-- Social campaign form content -->
                </div>
                
                <!-- In-App Ad Campaign Form (hidden by default) -->
                <div class="campaign-form" id="inAppAdCampaignForm" style="display: none;">
                    <!-- In-app ad campaign form content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Details Modal -->
    <div class="modal-overlay" id="campaignDetailsModal" style="display: none;">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 id="detailsCampaignName">Campaign Details</h3>
                <button class="modal-close" id="closeDetailsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="campaign-details-container">
                    <!-- Campaign details content -->
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn secondary" id="editCampaignBtn">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn danger" id="archiveCampaignBtn">
                    <i class="fas fa-archive"></i> Archive
                </button>
                <button class="btn primary" id="closeDetailsBtn">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Script Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

    <!-- Main Application Script -->
     <script src="/dashboard/dashboard.js"></script>
     
    <script>document.addEventListener('DOMContentLoaded', function() {
            // In your init function
            emailjs.init("cy9YL054A1rcf2BH4", {
                blockHeadless: true,
                limitRate: {
                    id: 'campaign',
                    throttle: 5000 
                }
            });
        
        // DOM Elements
        const elements = {
            newCampaignBtn: document.getElementById('newCampaignBtn'),
            newCampaignModal: document.getElementById('newCampaignModal'),
            closeModal: document.getElementById('closeModal'),
            campaignTypeOptions: document.querySelectorAll('.type-option'),
            emailCampaignForm: document.getElementById('emailCampaignForm'),
            socialCampaignForm: document.getElementById('socialCampaignForm'),
            inAppAdCampaignForm: document.getElementById('inAppAdCampaignForm'),
            viewBtns: document.querySelectorAll('.view-btn'),
            gridView: document.getElementById('gridView'),
            tableView: document.getElementById('tableView'),
            analyticsView: document.getElementById('analyticsView'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            campaignGrid: document.getElementById('campaignGrid'),
            campaignTableBody: document.getElementById('campaignTableBody'),
            emailSchedule: document.getElementById('emailSchedule'),
            scheduleDateTime: document.getElementById('scheduleDateTime'),
            emailSendTime: document.getElementById('emailSendTime'),
            nextBtns: document.querySelectorAll('.next-btn'),
            backBtns: document.querySelectorAll('.back-btn'),
            formSteps: document.querySelectorAll('.form-step'),
            sendEmailCampaign: document.getElementById('sendEmailCampaign'),
            campaignDetailsModal: document.getElementById('campaignDetailsModal'),
            closeDetailsModal: document.getElementById('closeDetailsModal'),
            editCampaignBtn: document.getElementById('editCampaignBtn'),
            archiveCampaignBtn: document.getElementById('archiveCampaignBtn'),
            closeDetailsBtn: document.getElementById('closeDetailsBtn'),
            applyFilters: document.getElementById('applyFilters'),
            statusFilter: document.getElementById('statusFilter'),
            campaignCount: document.getElementById('campaignCount'),
            statsGrid: document.getElementById('statsGrid'),
            topCampaignsList: document.getElementById('topCampaignsList'),
            dateFilter: document.getElementById('dateFilter'),
            analyticsTimeRange: document.getElementById('analyticsTimeRange'),
            topCampaignsFilter: document.getElementById('topCampaignsFilter'),
            sortFilter: document.getElementById('sortFilter'),
            sidebarToggle: document.getElementById('sidebarToggle'),
            sidebar: document.querySelector('.sidebar'),
            recipientsList: document.getElementById('recipientsList'),
            recipientSearch: document.getElementById('recipientSearch'),
            selectAllBtn: document.getElementById('selectAllBtn'),
            deselectAllBtn: document.getElementById('deselectAllBtn')
        };
    
        // State variables
        let currentCampaigns = [];
        let currentView = 'grid';
        let currentFilter = 'all';
        let currentCampaignDetails = null;
        let performanceChart = null;
        let typeChart = null;
        let currentPage = 1;
        const campaignsPerPage = 8;
        let quill = null;
    
        // API Endpoints
        const API_BASE_URL = 'http://localhost:8000/api';
        const API_ENDPOINTS = {
            CAMPAIGNS: `${API_BASE_URL}/campaigns`,
            CAMPAIGN_DETAILS: (id) => `${API_BASE_URL}/campaigns/${id}`,
            RECIPIENTS: `${API_BASE_URL}/marketing`
        };
    
        // Initialize Quill editor
        function initQuillEditor() {
            quill = new Quill('#emailEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'header': [1, 2, 3, false] }],
                        ['link', 'image'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
    
            // Update email preview when content changes
            quill.on('text-change', function() {
                const previewContent = document.getElementById('emailPreviewContent');
                previewContent.innerHTML = DOMPurify.sanitize(quill.root.innerHTML);
            });
        }
    
        // Initialize the application
        function init() {
            initQuillEditor();
            setupEventListeners();
            renderCampaignGrid();
        }
    
        // Setup all event listeners
        function setupEventListeners() {
            // New campaign button
            elements.newCampaignBtn.addEventListener('click', openNewCampaignModal);
            
            // Close modal button
            elements.closeModal.addEventListener('click', closeNewCampaignModal);
            
            // Campaign type selection
            elements.campaignTypeOptions.forEach(option => {
                option.addEventListener('click', () => selectCampaignType(option));
            });
            
            // View selector
            elements.viewBtns.forEach(btn => {
                btn.addEventListener('click', () => switchView(btn.dataset.view));
            });
            
            // Tab selector
            elements.tabBtns.forEach(btn => {
                btn.addEventListener('click', () => filterCampaigns(btn.dataset.type));
            });
            
            // Schedule datetime toggle
            elements.emailSchedule.addEventListener('change', toggleScheduleDateTime);
            
            // Form navigation
            setupFormNavigation();
            
            // Form submission
            elements.sendEmailCampaign.addEventListener('click', submitEmailCampaign);
            
            // Campaign details modal
            elements.closeDetailsModal.addEventListener('click', closeCampaignDetailsModal);
            elements.closeDetailsBtn.addEventListener('click', closeCampaignDetailsModal);
            elements.editCampaignBtn.addEventListener('click', editCurrentCampaign);
            elements.archiveCampaignBtn.addEventListener('click', archiveCurrentCampaign);
            
            // Filters
            elements.applyFilters.addEventListener('click', applyCampaignFilters);
            
            // Sidebar toggle
            elements.sidebarToggle.addEventListener('click', toggleSidebar);

            
            
            // Recipient selection
            elements.recipientSearch.addEventListener('input', filterRecipients);
            elements.selectAllBtn.addEventListener('click', selectAllRecipients);
            elements.deselectAllBtn.addEventListener('click', deselectAllRecipients);

            document.getElementById('emailAudience').addEventListener('change', function() {
    const customGroup = document.getElementById('customRecipientsGroup');
    customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
    
    if (this.value === 'custom' && !customGroup.querySelector('.recipient-item')) {
        loadRecipients();
    }
});
        }


    
        // Form navigation setup
        function setupFormNavigation() {
            // Next buttons
            elements.nextBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const currentStep = btn.closest('.form-step');
                    const nextStepNum = btn.dataset.next;
                    
                    // Validate current step before proceeding
                    if (!validateFormStep(currentStep)) {
                        return;
                    }
                    
                    // Update review section if we're going to the final step
                    if (nextStepNum === '5') {
                        updateReviewSection();
                    }
                    
                    navigateToStep(currentStep, nextStepNum);
                });
            });
            
            // Back buttons
            elements.backBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const currentStep = btn.closest('.form-step');
                    const prevStepNum = btn.dataset.back;
                    navigateToStep(currentStep, prevStepNum);
                });
            });
        }
    
        // Navigate between form steps
        function navigateToStep(currentStep, targetStepNum) {
            currentStep.classList.remove('active');
            document.querySelector(`.form-step[data-step="${targetStepNum}"]`).classList.add('active');
        }
    
        // Validate form step
        function validateFormStep(step) {
            let isValid = true;
            const requiredFields = step.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                const formGroup = field.closest('.form-group');
                formGroup.classList.remove('error', 'success');
                
                // Skip validation for hidden fields
                if (field.offsetParent === null) return;
                
                if (field.type === 'checkbox') {
                    if (!field.checked) {
                        formGroup.classList.add('error');
                        isValid = false;
                    } else {
                        formGroup.classList.add('success');
                    }
                } else if (field.value.trim() === '') {
                    formGroup.classList.add('error');
                    isValid = false;
                } else {
                    formGroup.classList.add('success');
                    
                    // Additional validation for email fields
                    if (field.type === 'email' && !isValidEmail(field.value)) {
                        formGroup.classList.add('error');
                        isValid = false;
                    }
                }
            });


            // In the step 2 validation section:
if (document.getElementById('emailAudience').value === 'custom') {
    const validCount = parseInt(document.getElementById('selectedRecipientCount').textContent);
    if (validCount === 0) {
        document.getElementById('customRecipientsGroup').classList.add('error');
        isValid = false;
    }
}
            
            // Special validation for custom recipients
            if (step.dataset.step === '2' && document.getElementById('emailAudience').value === 'custom') {
                const recipientGroup = document.getElementById('customRecipientsGroup');
                const selectedCount = parseInt(document.getElementById('selectedRecipientCount').textContent);
                
                if (selectedCount === 0) {
                    recipientGroup.classList.add('error');
                    isValid = false;
                } else {
                    recipientGroup.classList.remove('error');
                }
            }
            
            // Special validation for email content
            if (step.dataset.step === '3') {
                const content = quill.getText().trim();
                const contentGroup = document.querySelector('#emailEditor').closest('.form-group');
                
                if (content === '') {
                    contentGroup.classList.add('error');
                    isValid = false;
                } else {
                    contentGroup.classList.remove('error');
                }
            }
            
            return isValid;
        }
    
        // Check if email is valid
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
    
        // Open new campaign modal
        function openNewCampaignModal() {
            elements.newCampaignModal.style.display = 'flex';
            currentCampaignDetails = null; // Reset in case we're creating a new campaign
            
            // Reset forms
            document.querySelectorAll('.campaign-form').forEach(form => {
                form.style.display = 'none';
                form.reset();
            });
            
            // Reset form steps
            document.querySelectorAll('.form-step').forEach(step => {
                if (step.dataset.step === '1') {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
            
            // Reset type options
            document.querySelectorAll('.type-option').forEach(opt => opt.classList.remove('selected'));
            
            // Reset Quill editor
            if (quill) {
                quill.setContents([]);
            }
        }
    
        // Close new campaign modal
        function closeNewCampaignModal() {
            elements.newCampaignModal.style.display = 'none';
            
            // Reset forms
            document.querySelectorAll('.campaign-form').forEach(form => {
                form.style.display = 'none';
                form.reset();
            });
            
            // Reset form steps
            document.querySelectorAll('.form-step').forEach(step => {
                if (step.dataset.step === '1') {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
            
            // Reset type options
            document.querySelectorAll('.type-option').forEach(opt => opt.classList.remove('selected'));
        }
    
        // Select campaign type
        function selectCampaignType(option) {
            const type = option.dataset.type;
            
            // Hide all forms
            document.querySelectorAll('.campaign-form').forEach(form => form.style.display = 'none');
            
            // Show the correct form based on type
            let formId;
            switch (type) {
                case 'email':
                    formId = 'emailCampaignForm';
                    break;
                case 'social_media':
                    formId = 'socialCampaignForm';
                    break;
                case 'in_app_ad':
                    formId = 'inAppAdCampaignForm';
                    break;
            }
            
            if (formId) {
                document.getElementById(formId).style.display = 'block';
            }
            
            // Highlight selected option
            elements.campaignTypeOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            // Load recipients if email campaign
            if (type === 'email') {
                const audienceSelect = document.getElementById('emailAudience');
                if (audienceSelect.value === 'custom') {
                    loadRecipients();
                }
            }
        }
    
        // Switch between views (grid, table, analytics)
        function switchView(view) {
            currentView = view;
            
            // Update active button
            elements.viewBtns.forEach(b => b.classList.remove('active'));
            document.querySelector(`.view-btn[data-view="${view}"]`).classList.add('active');
            
            // Show selected view
            elements.gridView.style.display = 'none';
            elements.tableView.style.display = 'none';
            elements.analyticsView.style.display = 'none';
            
            if (view === 'grid') {
                elements.gridView.style.display = 'block';
                renderCampaignGrid(currentFilter);
            } else if (view === 'table') {
                elements.tableView.style.display = 'block';
                renderCampaignTable(currentFilter);
            } else if (view === 'analytics') {
                elements.analyticsView.style.display = 'block';
                renderAnalyticsView(currentFilter);
            }
        }
    
        // Filter campaigns by type
        function filterCampaigns(type) {
            currentFilter = type;
            currentPage = 1;
            
            // Update active tab
            elements.tabBtns.forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[data-type="${type}"]`).classList.add('active');
            
            // Refresh view
            refreshCampaigns();
        }
    
        // Apply campaign filters
        function applyCampaignFilters() {
            currentPage = 1;
            refreshCampaigns();
        }
    
        // Toggle schedule date time field
        function toggleScheduleDateTime() {
            elements.scheduleDateTime.style.display = this.value === 'scheduled' ? 'block' : 'none';
        }
    
        // Load recipients from API
        async function loadRecipients() {
            const recipientsList = document.querySelector('.recipients-list');
            recipientsList.innerHTML = '<div class="loading-spinner"></div><p>Loading recipients...</p>';
            
            try {
                const response = await fetch('http://localhost:8000/api/marketing');
                if (!response.ok) {
                    throw new Error('Failed to load recipients');
                }
                const data = await response.json();
                
                recipientsList.innerHTML = '';
                data.forEach((subscriber, index) => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'recipient-item';
                    checkbox.innerHTML = `
                        <input type="checkbox" id="recipient-${index}" value="${subscriber.email}">
                        <label for="recipient-${index}">
                            ${subscriber.name || 'Subscriber'} (${subscriber.email})
                        </label>
                    `;
                    checkbox.querySelector('input').addEventListener('change', updateRecipientCount);
                    recipientsList.appendChild(checkbox);
                });
            } catch (error) {
                console.error('Error loading recipients:', error);
                recipientsList.innerHTML = '<p class="error">Failed to load recipients. Please try again.</p>';
            }
        }
    
        // Render recipients list
        function renderRecipients(recipients) {
            const recipientsList = document.getElementById('recipientsList');
            recipientsList.innerHTML = '';
            
            if (recipients.length === 0) {
                recipientsList.innerHTML = '<p>No recipients found</p>';
                return;
            }
            
            recipients.forEach((recipient, index) => {
                const recipientItem = document.createElement('div');
                recipientItem.className = 'recipient-item';
                
                const email = recipient.email || recipient;
                const name = recipient.name || email.split('@')[0];
                const isValid = isValidEmail(email);
                
                recipientItem.innerHTML = `
                    <input type="checkbox" id="recipient-${index}" value="${email}" 
                           class="recipient-checkbox" ${isValid ? '' : 'disabled'}>
                    <label for="recipient-${index}" class="${isValid ? '' : 'invalid-email'}">
                        ${name} (${email}) ${isValid ? '' : '(invalid)'}
                    </label>
                `;
                
                recipientsList.appendChild(recipientItem);
            });
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.recipient-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateRecipientCount);
            });
            
            updateRecipientCount();
        }
    
        // Filter recipients by search term
        function filterRecipients() {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll('.recipient-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }
    
        // Select all recipients
        function selectAllRecipients() {
            document.querySelectorAll('.recipient-checkbox:not(:disabled)').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event('change'));
            });
        }
    
        // Deselect all recipients
        function deselectAllRecipients() {
            document.querySelectorAll('.recipient-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
        }
    
        function updateRecipientCount() {
    const validCheckboxes = document.querySelectorAll('.recipient-checkbox:not([data-invalid]):checked');
    const invalidCheckboxes = document.querySelectorAll('.recipient-checkbox[data-invalid]:checked');
    
    document.getElementById('selectedRecipientCount').textContent = validCheckboxes.length;
    document.getElementById('emailRecipientCount').value = validCheckboxes.length;
    
    // Add actual emails to hidden input for preview
    const selectedEmails = Array.from(validCheckboxes).map(cb => cb.value);
    document.getElementById('selectedRecipientsHidden').value = selectedEmails.join(',');
     
            const invalidCountSpan = document.querySelector('#invalidEmailsCount span');
            if (invalidEmails > 0) {
                invalidCountSpan.textContent = invalidEmails;
                document.getElementById('invalidEmailsCount').style.display = 'inline';
            } else {
                document.getElementById('invalidEmailsCount').style.display = 'none';
            }
        }
    
        // Update the review section before submission
        function updateReviewSection() {
            // Campaign details
            document.getElementById('reviewCampaignName').textContent = 
                document.getElementById('emailCampaignName').value || '-';
            document.getElementById('reviewDescription').textContent = 
                document.getElementById('emailDescription').value || '-';
            document.getElementById('reviewSubject').textContent = 
                document.getElementById('emailSubject').value || '-';
            document.getElementById('reviewSender').textContent = 
                document.getElementById('emailSenderName').value || '-';
            
 // Recipients information
 const audienceSelect = document.getElementById('emailAudience');
    const reviewRecipients = document.getElementById('reviewRecipients');
    
    if (audienceSelect.value === 'custom') {
        const selected = Array.from(document.querySelectorAll('.recipient-checkbox:checked'))
                            .map(checkbox => checkbox.value);
        reviewRecipients.innerHTML = selected.map(email => 
            `<span>${email}</span>`
        ).join('');
    } else {
        reviewRecipients.textContent = 
            `${document.getElementById('emailRecipientCount').value} recipients (${audienceSelect.options[audienceSelect.selectedIndex].text})`;
    }
            
            // Status and schedule
            document.getElementById('reviewStatus').textContent = 
                document.getElementById('emailStatus').options[document.getElementById('emailStatus').selectedIndex].text;
            
            const scheduleValue = document.getElementById('emailSchedule').value;
            let scheduleText = '';
            if (scheduleValue === 'now') {
                scheduleText = 'Send immediately';
            } else if (scheduleValue === 'scheduled') {
                scheduleText = `Schedule for ${document.getElementById('emailSendTime').value}`;
            } else {
                scheduleText = 'Save as draft';
            }
            document.getElementById('reviewSchedule').textContent = scheduleText;
            
            // Update preview
            document.getElementById('previewSubject').textContent = 
                document.getElementById('emailSubject').value || 'Your Email Subject Here';
            document.getElementById('previewSender').textContent = 
                document.getElementById('emailSenderName').value || 'WFFE Connect';
        }
    
        // Submit email campaign
        async function submitEmailCampaign() {
            // Validate the entire form first
            const formSteps = document.querySelectorAll('#emailCampaignForm .form-step');
            for (const step of formSteps) {
                if (!validateFormStep(step)) {
                    // Show the first invalid step
                    document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
                    step.classList.add('active');
                    return;
                }
            }
            
            const sendBtn = document.getElementById('sendEmailCampaign');
            const btnText = sendBtn.querySelector('.btn-text');
            const btnLoading = sendBtn.querySelector('.btn-loading');
            
            // Show loading state
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            sendBtn.disabled = true;
            
            try {
        const emailParams = {
            subject: document.getElementById('emailSubject').value,
            sender_name: document.getElementById('emailSenderName').value,
            to_email: Array.from(document.querySelectorAll('.recipient-checkbox:checked'))
                         .map(checkbox => checkbox.value),
            body: quill.root.innerHTML
        };
                    // Add this to your emailParams when images are included
            const images = Array.from(quill.root.querySelectorAll('img'));
            emailParams.attachments = await Promise.all(images.map(async (img) => {
                const response = await fetch(img.src);
                const blob = await response.blob();
                return {
                    filename: `image-${Date.now()}.png`,
                    content: blob
                };
            }));

        // Show loading state
        const sendBtn = document.getElementById('sendEmailCampaign');
        sendBtn.disabled = true;
        document.querySelector('.btn-text').style.display = 'none';
        document.querySelector('.btn-loading').style.display = 'flex';



        const response = await emailjs.send(
    'service_s6dfizl', // Replace with actual service ID
    'template_hmt1dnw', // Replace with actual template ID
    emailParams
);

        if (response.status === 200) {
            showSuccess(`Emails sent successfully to ${emailParams.to_email.length} recipients!`);
            closeNewCampaignModal();
            refreshCampaigns();
        }
    } catch (error) {
        console.error('Email sending failed:', error);
        showError(`Failed to send emails: ${error.text}`);
    } finally {
        sendBtn.disabled = false;
        document.querySelector('.btn-text').style.display = 'flex';
        document.querySelector('.btn-loading').style.display = 'none';
    }
}

    
// Update the showCampaignDetails function
async function showCampaignDetails(id) {
    // Show loading state
    elements.campaignDetailsModal.style.display = 'flex';
    document.querySelector('.campaign-details-container').innerHTML = '<div class="loading-spinner"></div><p>Loading campaign details...</p>';
    
    try {
        const response = await fetch(API_ENDPOINTS.CAMPAIGN_DETAILS(id));
        if (!response.ok) {
            throw new Error('Failed to fetch campaign details');
        }
        
        const campaign = await response.json();
        currentCampaignDetails = campaign;
        
        // Create the details HTML
        const detailsHTML = `
            <div class="details-header">
                <h2>${campaign.name}</h2>
                <div class="details-type-badge ${campaign.campaign_type}">
                    <i class="${getCampaignTypeIcon(campaign.campaign_type)}"></i>
                    <span>${getCampaignTypeLabel(campaign.campaign_type)}</span>
                </div>
                <div class="details-status-badge ${campaign.status}">
                    ${campaign.status.charAt(0).toUpperCase() + campaign.status.slice(1)}
                </div>
            </div>
            
            <div class="details-content">
                <div class="details-section">
                    <h4>Overview</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <label>Start Date</label>
                            <p>${formatDate(campaign.start_date)}</p>
                        </div>
                        <div class="detail-item">
                            <label>End Date</label>
                            <p>${campaign.end_date ? formatDate(campaign.end_date) : 'Ongoing'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Created At</label>
                            <p>${formatDate(campaign.created_at)}</p>
                        </div>
                        <div class="detail-item">
                            <label>Last Updated</label>
                            <p>${formatDate(campaign.updated_at)}</p>
                        </div>
                        <div class="detail-item full-width">
                            <label>Description</label>
                            <p>${campaign.description || 'No description provided'}</p>
                        </div>
                    </div>
                </div>
                
                ${campaign.campaign_type === 'email' ? `
                <div class="details-section" id="emailDetailsSection">
                    <h4>Email Details</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <label>Subject</label>
                            <p>${campaign.email_subject || '-'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Sender Name</label>
                            <p>${campaign.sender_name || '-'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Recipient Count</label>
                            <p>${campaign.recipient_count ? formatNumber(campaign.recipient_count) : '-'}</p>
                        </div>
                        <div class="detail-item">
                            <label>Template ID</label>
                            <p>${campaign.template_id || '-'}</p>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div class="details-section">
                    <h4>Performance</h4>
                    <div class="performance-stats">
                        <div class="stat-card">
                            <div class="stat-value">${formatNumber(campaign.impressions)}</div>
                            <div class="stat-label">Impressions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatNumber(campaign.clicks)}</div>
                            <div class="stat-label">Clicks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatNumber(campaign.conversions)}</div>
                            <div class="stat-label">Conversions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(campaign.revenue)}</div>
                            <div class="stat-label">Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatPercentage(campaign.ctr || 0)}</div>
                            <div class="stat-label">CTR</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatPercentage(campaign.conversion_rate || 0)}</div>
                            <div class="stat-label">Conversion Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Update the modal content
        document.querySelector('.campaign-details-container').innerHTML = detailsHTML;
        
    } catch (error) {
        console.error('Error loading campaign details:', error);
        document.querySelector('.campaign-details-container').innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>Failed to load campaign details. Please try again.</p>
                <button class="btn secondary" onclick="showCampaignDetails(${id})">Retry</button>
            </div>
        `;
    }
}

// Update the updateCampaignDetailsModal function (if you have one)
function updateCampaignDetailsModal(campaign) {
    // This is now handled directly in showCampaignDetails
}

// Make sure your modal HTML has this structure:
/*
<div class="modal-overlay" id="campaignDetailsModal" style="display: none;">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 id="detailsCampaignName">Campaign Details</h3>
            <button class="modal-close" id="closeDetailsModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="campaign-details-container">
                <!-- Content will be inserted here dynamically -->
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn secondary" id="editCampaignBtn">
                <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn danger" id="archiveCampaignBtn">
                <i class="fas fa-archive"></i> Archive
            </button>
            <button class="btn primary" id="closeDetailsBtn">
                Close
            </button>
        </div>
    </div>
</div>
*/    
        // Update campaign details modal with data
        function updateCampaignDetailsModal(campaign) {
            document.getElementById('detailsCampaignName').textContent = campaign.name;
            
            // Update type badge
            const typeBadge = document.getElementById('detailsTypeBadge');
            typeBadge.innerHTML = `
                <i class="${getCampaignTypeIcon(campaign.campaign_type)}"></i>
                <span>${getCampaignTypeLabel(campaign.campaign_type)}</span>
            `;
            typeBadge.className = `details-type-badge ${campaign.campaign_type}`;
            
            // Update status badge
            const statusBadge = document.getElementById('detailsStatusBadge');
            statusBadge.textContent = campaign.status.charAt(0).toUpperCase() + campaign.status.slice(1);
            statusBadge.className = `details-status-badge ${campaign.status}`;
            
            // Update overview
            document.getElementById('detailsStartDate').textContent = formatDate(campaign.start_date);
            document.getElementById('detailsEndDate').textContent = formatDate(campaign.end_date);
            document.getElementById('detailsCreatedAt').textContent = formatDate(campaign.created_at);
            document.getElementById('detailsUpdatedAt').textContent = formatDate(campaign.updated_at);
            document.getElementById('detailsDescription').textContent = campaign.description || '-';
            
            // Hide all type-specific sections
            document.getElementById('emailDetailsSection').style.display = 'none';
            document.getElementById('socialDetailsSection').style.display = 'none';
            document.getElementById('adDetailsSection').style.display = 'none';
            
            // Show type-specific details
            if (campaign.campaign_type === 'email') {
                document.getElementById('emailDetailsSection').style.display = 'block';
                document.getElementById('detailsEmailSubject').textContent = campaign.email_subject || '-';
                document.getElementById('detailsRecipientCount').textContent = formatNumber(campaign.recipient_count);
                document.getElementById('detailsSenderName').textContent = campaign.sender_name || '-';
                document.getElementById('detailsTemplateId').textContent = campaign.template_id || '-';
            }
            
            // Update performance stats
            document.getElementById('detailsImpressions').textContent = formatNumber(campaign.impressions);
            document.getElementById('detailsClicks').textContent = formatNumber(campaign.clicks);
            document.getElementById('detailsConversions').textContent = formatNumber(campaign.conversions);
            document.getElementById('detailsRevenue').textContent = formatCurrency(campaign.revenue);
            document.getElementById('detailsCTR').textContent = formatPercentage(campaign.ctr || 0);
            document.getElementById('detailsConversionRate').textContent = formatPercentage(campaign.conversion_rate || 0);
        }
    
        // Close campaign details modal
        function closeCampaignDetailsModal() {
            elements.campaignDetailsModal.style.display = 'none';
            currentCampaignDetails = null;
        }
    
        // Edit current campaign
        async function editCurrentCampaign() {
            if (currentCampaignDetails) {
                closeCampaignDetailsModal();
                await editCampaign(currentCampaignDetails.campaign_id);
            }
        }
    
        // Archive current campaign
        async function archiveCurrentCampaign() {
            if (currentCampaignDetails && confirm('Are you sure you want to archive this campaign?')) {
                try {
                    const response = await fetch(API_ENDPOINTS.CAMPAIGN_DETAILS(currentCampaignDetails.campaign_id), {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to archive campaign');
                    }
                    
                    showSuccess('Campaign archived successfully!');
                    closeCampaignDetailsModal();
                    refreshCampaigns();
                } catch (error) {
                    console.error('Error archiving campaign:', error);
                    showError('Failed to archive campaign. Please try again.');
                }
            }
        }
    
        // Edit campaign
        async function editCampaign(id) {
            try {
                const response = await fetch(API_ENDPOINTS.CAMPAIGN_DETAILS(id));
                if (!response.ok) {
                    throw new Error('Failed to fetch campaign details');
                }
                
                const campaign = await response.json();
                currentCampaignDetails = campaign;
                
                // Open the modal with the campaign data pre-filled
                elements.newCampaignModal.style.display = 'flex';
                
                // Reset forms
                document.querySelectorAll('.campaign-form').forEach(form => {
                    form.style.display = 'none';
                });
                
                // Show email form
                elements.emailCampaignForm.style.display = 'block';
                
                // Fill in the form fields
                document.getElementById('emailCampaignName').value = campaign.name;
                document.getElementById('emailDescription').value = campaign.description || '';
                document.getElementById('emailSubject').value = campaign.email_subject || '';
                document.getElementById('emailAudience').value = 'all'; // Default, you'd need to map this
                document.getElementById('emailRecipientCount').value = campaign.recipient_count || '';
                document.getElementById('emailSenderName').value = campaign.sender_name || '';
                document.getElementById('emailStatus').value = campaign.status;
                document.getElementById('emailTemplateId').value = campaign.template_id || '';
                
                // Set schedule based on status
                if (campaign.status === 'scheduled') {
                    document.getElementById('emailSchedule').value = 'scheduled';
                    document.getElementById('emailSendTime').value = campaign.start_date.split('T')[0];
                    elements.scheduleDateTime.style.display = 'block';
                } else if (campaign.status === 'active') {
                    document.getElementById('emailSchedule').value = 'now';
                } else {
                    document.getElementById('emailSchedule').value = 'draft';
                }
                
                // Highlight email option
                document.querySelector('.type-option[data-type="email"]').classList.add('selected');
                
                // Set content in Quill editor
                if (quill && campaign.content) {
                    quill.root.innerHTML = campaign.content;
                }
            } catch (error) {
                console.error('Error loading campaign for editing:', error);
                showError('Failed to load campaign for editing. Please try again.');
            }
        }
    
        // Refresh campaigns based on current view and filters
        function refreshCampaigns() {
            if (currentView === 'grid') {
                renderCampaignGrid(currentFilter);
            } else if (currentView === 'table') {
                renderCampaignTable(currentFilter);
            } else if (currentView === 'analytics') {
                renderAnalyticsView(currentFilter);
            }
        }
    
        // Render campaign grid view
        async function renderCampaignGrid(filterType = 'all') {
            const grid = elements.campaignGrid;
            grid.innerHTML = '<div class="campaign-card loading"><div class="loading-spinner"></div><p>Loading campaigns...</p></div>';
            
            try {
                const response = await fetch(API_ENDPOINTS.CAMPAIGNS);
                if (!response.ok) {
                    throw new Error('Failed to fetch campaigns');
                }
                
                const campaigns = await response.json();
                
                // Filter campaigns based on type
                const filteredCampaigns = filterType === 'all' 
                    ? campaigns 
                    : campaigns.filter(c => {
                        if (filterType === 'email') return c.campaign_type === 'email';
                        if (filterType === 'social') return c.campaign_type === 'social_media';
                        if (filterType === 'paid') return c.campaign_type === 'in_app_ad';
                        return true;
                    });
                
                // Update campaign count
                elements.campaignCount.textContent = filteredCampaigns.length;
                
                if (filteredCampaigns.length === 0) {
                    grid.innerHTML = '<div class="campaign-card empty"><p>No campaigns found</p></div>';
                    // Clear pagination
                    document.querySelectorAll('.pagination').forEach(p => p.innerHTML = '');
                    return;
                }
                
                // Apply pagination
                const paginatedCampaigns = getPaginatedCampaigns(filteredCampaigns, currentPage, campaignsPerPage);
                renderPagination(filteredCampaigns, currentPage, campaignsPerPage);
                
                grid.innerHTML = '';
                
                paginatedCampaigns.forEach(campaign => {
                    const card = document.createElement('div');
                    card.className = `campaign-card ${campaign.status}`;
                    card.dataset.id = campaign.campaign_id;
                    
                    // Common stats for all campaign types
                    const impressions = formatNumber(campaign.impressions);
                    const clicks = formatNumber(campaign.clicks);
                    const revenue = formatCurrency(campaign.revenue);
                    const ctr = formatPercentage(campaign.ctr || 0);
                    const conversionRate = formatPercentage(campaign.conversion_rate || 0);
                    
                    // Type-specific stats
                    let typeSpecificStats = '';
                    if (campaign.campaign_type === 'email') {
                        typeSpecificStats = `
                            <div class="campaign-stats">
                                <div>
                                    <small>Recipients</small>
                                    <p>${formatNumber(campaign.recipient_count)}</p>
                                </div>
                                <div>
                                    <small>Open Rate</small>
                                    <p>${ctr}</p>
                                </div>
                                <div>
                                    <small>Revenue</small>
                                    <p>${revenue}</p>
                                </div>
                            </div>
                        `;
                    } else if (campaign.campaign_type === 'social_media') {
                        typeSpecificStats = `
                            <div class="campaign-stats">
                                <div>
                                    <small>Impressions</small>
                                    <p>${impressions}</p>
                                </div>
                                <div>
                                    <small>Engagements</small>
                                    <p>${clicks}</p>
                                </div>
                                <div>
                                    <small>Revenue</small>
                                    <p>${revenue}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        typeSpecificStats = `
                            <div class="campaign-stats">
                                <div>
                                    <small>Impressions</small>
                                    <p>${impressions}</p>
                                </div>
                                <div>
                                    <small>Clicks</small>
                                    <p>${clicks}</p>
                                </div>
                                <div>
                                    <small>Revenue</small>
                                    <p>${revenue}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    card.innerHTML = `
                        <div class="campaign-card-header">
                            <div class="campaign-type ${campaign.campaign_type}">
                                <i class="${getCampaignTypeIcon(campaign.campaign_type)}"></i>
                                ${getCampaignTypeLabel(campaign.campaign_type)}
                            </div>
                            <h3>${campaign.name}</h3>
                            <span class="status-badge ${campaign.status}">${campaign.status.charAt(0).toUpperCase() + campaign.status.slice(1)}</span>
                        </div>
                        <div class="campaign-card-dates">
                            <div>
                                <small>Start Date</small>
                                <p>${formatDate(campaign.start_date)}</p>
                            </div>
                            <div>
                                <small>End Date</small>
                                <p>${formatDate(campaign.end_date)}</p>
                            </div>
                        </div>
                        ${typeSpecificStats}
                        <div class="campaign-card-actions">
                            <button class="action-btn view">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn ${campaign.status === 'draft' ? 'edit' : 'duplicate'}">
                                <i class="fas ${campaign.status === 'draft' ? 'fa-pencil-alt' : 'fa-copy'}"></i>
                            </button>
                            <button class="action-btn more">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.campaign-card .action-btn.view').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const card = e.target.closest('.campaign-card');
                        const campaignId = card.dataset.id;
                        await showCampaignDetails(campaignId);
                    });
                });
        
                // Add event listeners to edit/duplicate buttons
                document.querySelectorAll('.campaign-card .action-btn.edit, .campaign-card .action-btn.duplicate').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const card = e.target.closest('.campaign-card');
                        const campaignId = card.dataset.id;
                        const isEdit = btn.classList.contains('edit');
                        
                        if (isEdit) {
                            await editCampaign(campaignId);
                        } else {
                            await duplicateCampaign(campaignId);
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading campaigns:', error);
                grid.innerHTML = '<div class="campaign-card empty"><p>Error loading campaigns</p></div>';
            }
        }
    
        // Render campaign table view
        async function renderCampaignTable(filterType = 'all') {
            const tableBody = elements.campaignTableBody;
            tableBody.innerHTML = '<tr><td colspan="8" class="loading-row"><div class="loading-spinner"></div><p>Loading campaigns...</p></td></tr>';
            
            try {
                const response = await fetch(API_ENDPOINTS.CAMPAIGNS);
                if (!response.ok) {
                    throw new Error('Failed to fetch campaigns');
                }
                
                const campaigns = await response.json();
                
                // Filter campaigns based on type
                const filteredCampaigns = filterType === 'all' 
                    ? campaigns 
                    : campaigns.filter(c => {
                        if (filterType === 'email') return c.campaign_type === 'email';
                        if (filterType === 'social') return c.campaign_type === 'social_media';
                        if (filterType === 'paid') return c.campaign_type === 'in_app_ad';
                        return true;
                    });
                
                if (filteredCampaigns.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="empty-row"><p>No campaigns found</p></td></tr>';
                    // Clear pagination
                    document.querySelectorAll('.pagination').forEach(p => p.innerHTML = '');
                    return;
                }
                
                // Apply pagination
                const paginatedCampaigns = getPaginatedCampaigns(filteredCampaigns, currentPage, campaignsPerPage);
                renderPagination(filteredCampaigns, currentPage, campaignsPerPage);
                
                tableBody.innerHTML = '';
                
                paginatedCampaigns.forEach(campaign => {
                    const row = document.createElement('tr');
                    row.dataset.id = campaign.campaign_id;
                    
                    const ctr = campaign.ctr ? `${campaign.ctr.toFixed(2)}%` : '-';
                    const conversionRate = campaign.conversion_rate ? `${campaign.conversion_rate.toFixed(2)}%` : '-';
                    
                    row.innerHTML = `
                        <td>
                            <div class="campaign-name">
                                <i class="${getCampaignTypeIcon(campaign.campaign_type)}"></i>
                                <span>${campaign.name}</span>
                            </div>
                        </td>
                        <td>
                            <span class="campaign-type ${campaign.campaign_type}">
                                ${getCampaignTypeLabel(campaign.campaign_type)}
                            </span>
                        </td>
                        <td><span class="status-badge ${campaign.status}">${campaign.status.charAt(0).toUpperCase() + campaign.status.slice(1)}</span></td>
                        <td>${formatNumber(campaign.impressions)}</td>
                        <td>
                            <div class="metric-with-trend">
                                <span class="value">${ctr}</span>
                                <span class="trend ${campaign.ctr > 5 ? 'up' : 'down'}">
                                    <i class="fas fa-arrow-${campaign.ctr > 5 ? 'up' : 'down'}"></i>
                                </span>
                            </div>
                        </td>
                        <td>${formatCurrency(campaign.revenue)}</td>
                        <td>${formatDate(campaign.start_date)}</td>
                        <td>
                            <div class="table-actions">
                                <button class="action-btn view">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn ${campaign.status === 'draft' ? 'edit' : 'duplicate'}">
                                    <i class="fas ${campaign.status === 'draft' ? 'fa-pencil-alt' : 'fa-copy'}"></i>
                                </button>
                                <button class="action-btn more">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.table-actions .action-btn.view').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const row = e.target.closest('tr');
                        const campaignId = row.dataset.id;
                        await showCampaignDetails(campaignId);
                    });
                });
        
                // Add event listeners to edit/duplicate buttons
                document.querySelectorAll('.table-actions .action-btn.edit, .table-actions .action-btn.duplicate').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const row = e.target.closest('tr');
                        const campaignId = row.dataset.id;
                        const isEdit = btn.classList.contains('edit');
                        
                        if (isEdit) {
                            await editCampaign(campaignId);
                        } else {
                            await duplicateCampaign(campaignId);
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading campaigns:', error);
                tableBody.innerHTML = '<tr><td colspan="8" class="error-row"><p>Error loading campaigns</p></td></tr>';
            }
        }
    
        // Render analytics view
        async function renderAnalyticsView(filterType = 'all') {
            // Show loading state
            elements.statsGrid.innerHTML = '<div class="loading-spinner"></div><p>Loading analytics...</p>';
            elements.topCampaignsList.innerHTML = '<div class="loading-spinner"></div><p>Loading top campaigns...</p>';
            
            try {
                const response = await fetch(API_ENDPOINTS.CAMPAIGNS);
                if (!response.ok) {
                    throw new Error('Failed to fetch campaigns');
                }
                
                const campaigns = await response.json();
                
                // Filter campaigns based on type
                const filteredCampaigns = filterType === 'all' 
                    ? campaigns 
                    : campaigns.filter(c => {
                        if (filterType === 'email') return c.campaign_type === 'email';
                        if (filterType === 'social') return c.campaign_type === 'social_media';
                        if (filterType === 'paid') return c.campaign_type === 'in_app_ad';
                        return true;
                    });
                
                // Calculate stats
                const totalCampaigns = filteredCampaigns.length;
                const emailCampaigns = filteredCampaigns.filter(c => c.campaign_type === 'email');
                const socialCampaigns = filteredCampaigns.filter(c => c.campaign_type === 'social_media');
                const adCampaigns = filteredCampaigns.filter(c => c.campaign_type === 'in_app_ad');
                
                // Avg open rate (for email campaigns)
                const avgOpenRate = emailCampaigns.length > 0 
                    ? emailCampaigns.reduce((sum, c) => sum + (c.ctr || 0), 0) / emailCampaigns.length
                    : 0;
                
                // Avg click rate (for all campaigns)
                const avgClickRate = filteredCampaigns.length > 0
                    ? filteredCampaigns.reduce((sum, c) => sum + (c.ctr || 0), 0) / filteredCampaigns.length
                    : 0;
                
                // Total revenue
                const totalRevenue = filteredCampaigns.reduce((sum, c) => sum + (c.revenue || 0), 0);
                
                // Update stats cards
                elements.statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #FFEE58;">
                            <i class="fas fa-bullhorn" style="color: #FBC02D;"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">${totalCampaigns}</div>
                            <div class="stat-label">Total Campaigns</div>
                        </div>
                        <div class="stat-trend up">
                            <i class="fas fa-arrow-up"></i> ${Math.floor(Math.random() * 15) + 5}%
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #B3E5FC;">
                            <i class="fas fa-envelope-open" style="color: #03A9F4;"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">${avgOpenRate.toFixed(2)}%</div>
                            <div class="stat-label">Avg Open Rate</div>
                        </div>
                        <div class="stat-trend ${avgOpenRate > 5 ? 'up' : 'down'}">
                            <i class="fas fa-arrow-${avgOpenRate > 5 ? 'up' : 'down'}"></i> ${Math.floor(Math.random() * 5) + 1}%
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #C8E6C9;">
                            <i class="fas fa-mouse-pointer" style="color: #4CAF50;"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">${avgClickRate.toFixed(2)}%</div>
                            <div class="stat-label">Avg Click Rate</div>
                        </div>
                        <div class="stat-trend ${avgClickRate > 3 ? 'up' : 'down'}">
                            <i class="fas fa-arrow-${avgClickRate > 3 ? 'up' : 'down'}"></i> ${Math.floor(Math.random() * 3) + 1}%
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #FFCDD2;">
                            <i class="fas fa-dollar-sign" style="color: #F44336;"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">${formatCurrency(totalRevenue)}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-trend up">
                            <i class="fas fa-arrow-up"></i> ${Math.floor(Math.random() * 20) + 5}%
                        </div>
                    </div>
                `;
                
                // Render charts
                initCharts(filteredCampaigns);
                
                // Render top campaigns
                renderTopCampaigns(filteredCampaigns);
            } catch (error) {
                console.error('Error loading analytics:', error);
                elements.statsGrid.innerHTML = '<p class="error">Failed to load analytics</p>';
                elements.topCampaignsList.innerHTML = '<p class="error">Failed to load top campaigns</p>';
            }
        }
    
        // Initialize charts
        function initCharts(campaigns) {
            // Destroy existing charts if they exist
            if (performanceChart) performanceChart.destroy();
            if (typeChart) typeChart.destroy();
            
            // Group campaigns by month for performance chart
            const monthlyData = {};
            campaigns.forEach(campaign => {
                const date = new Date(campaign.start_date);
                const month = date.toLocaleString('default', { month: 'short' });
                const year = date.getFullYear();
                const key = `${month} ${year}`;
                
                if (!monthlyData[key]) {
                    monthlyData[key] = {
                        email: 0,
                        social_media: 0,
                        in_app_ad: 0
                    };
                }
                
                monthlyData[key][campaign.campaign_type]++;
            });
            
            const months = Object.keys(monthlyData);
            const emailData = months.map(m => monthlyData[m].email || 0);
            const socialData = months.map(m => monthlyData[m].social_media || 0);
            const adData = months.map(m => monthlyData[m].in_app_ad || 0);
            
            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Email Campaigns',
                            data: emailData,
                            borderColor: '#9C27B0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Social Campaigns',
                            data: socialData,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'In-App Ads',
                            data: adData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Type Chart
            const emailCount = campaigns.filter(c => c.campaign_type === 'email').length;
            const socialCount = campaigns.filter(c => c.campaign_type === 'social_media').length;
            const adCount = campaigns.filter(c => c.campaign_type === 'in_app_ad').length;
            
            const typeCtx = document.getElementById('typeChart').getContext('2d');
            typeChart = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Email', 'Social Media', 'In-App Ads'],
                    datasets: [{
                        data: [emailCount, socialCount, adCount],
                        backgroundColor: [
                            '#9C27B0',
                            '#2196F3',
                            '#4CAF50'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        // Add to setupEventListeners()
document.getElementById('emailAudience').addEventListener('change', function() {
    const customGroup = document.getElementById('customRecipientsGroup');
    customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
    
    if (this.value === 'custom') {
        loadRecipients();
    }
});

async function loadRecipients() {
    const recipientsList = document.getElementById('recipientsList');
    recipientsList.innerHTML = '<div class="loading-spinner"></div><p>Loading recipients...</p>';

    try {
        const response = await fetch('http://localhost:8000/api/marketing');
        if (!response.ok) throw new Error('Failed to load recipients');
        const data = await response.json();

        recipientsList.innerHTML = '';
        data.forEach((subscriber) => {
            const isValid = isValidEmail(subscriber.email);
            const div = document.createElement('div');
            div.className = 'recipient-item';
            div.innerHTML = `
                <input type="checkbox" 
                    id="recipient-${subscriber.id}"
                    value="${subscriber.email}"
                    class="recipient-checkbox"
                    ${!isValid ? 'data-invalid disabled' : ''}
                >
                <label for="recipient-${subscriber.id}" 
                    class="${!isValid ? 'invalid-email' : ''}">
                    ${subscriber.name || subscriber.email.split('@')[0]} (${subscriber.email})
                    ${!isValid ? ' - Invalid' : ''}
                </label>
            `;
            div.querySelector('input').addEventListener('change', updateRecipientCount);
            recipientsList.appendChild(div);
        });
        updateRecipientCount();
    } catch (error) {
        console.error('Error loading recipients:', error);
        recipientsList.innerHTML = '<p class="error">Failed to load recipients</p>';
    }
}
function updateRecipientCount() {
    const validCheckboxes = document.querySelectorAll('.recipient-checkbox:not([data-invalid]):checked');
    const invalidCheckboxes = document.querySelectorAll('.recipient-checkbox[data-invalid]:checked');
    
    document.getElementById('selectedRecipientCount').textContent = validCheckboxes.length;
    document.getElementById('emailRecipientCount').value = validCheckboxes.length;
    
    const invalidCount = invalidCheckboxes.length;
    const invalidCountSpan = document.getElementById('invalidEmailsCount');
    invalidCountSpan.querySelector('span').textContent = invalidCount;
    invalidCountSpan.style.display = invalidCount > 0 ? 'inline' : 'none';
}   
        // Render top campaigns
        function renderTopCampaigns(campaigns) {
            // Sort campaigns by revenue descending
            const sortedCampaigns = [...campaigns].sort((a, b) => (b.revenue || 0) - (a.revenue || 0));
            const topCampaigns = sortedCampaigns.slice(0, 3); // Top 3 campaigns
            
            if (topCampaigns.length === 0) {
                elements.topCampaignsList.innerHTML = '<p>No campaigns found</p>';
                return;
            }
            
            elements.topCampaignsList.innerHTML = '';
            
            topCampaigns.forEach(campaign => {
                const item = document.createElement('div');
                item.className = 'top-campaign-item';
                
                const icon = getCampaignTypeIcon(campaign.campaign_type);
                const typeLabel = getCampaignTypeLabel(campaign.campaign_type);
                const revenue = formatCurrency(campaign.revenue);
                const ctr = formatPercentage(campaign.ctr || 0);
                const conversionRate = formatPercentage(campaign.conversion_rate || 0);
                
                // Type-specific stats
                let statsHtml = '';
                if (campaign.campaign_type === 'email') {
                    statsHtml = `
                        <div class="stat">
                            <div class="value">${ctr}</div>
                            <div class="label">Open Rate</div>
                        </div>
                        <div class="stat">
                            <div class="value">${conversionRate}</div>
                            <div class="label">Click Rate</div>
                        </div>
                    `;
                } else if (campaign.campaign_type === 'social_media') {
                    statsHtml = `
                        <div class="stat">
                            <div class="value">${formatNumber(campaign.impressions)}</div>
                            <div class="label">Impressions</div>
                        </div>
                        <div class="stat">
                            <div class="value">${formatNumber(campaign.clicks)}</div>
                            <div class="label">Engagements</div>
                        </div>
                    `;
                } else {
                    statsHtml = `
                        <div class="stat">
                            <div class="value">${formatNumber(campaign.impressions)}</div>
                            <div class="label">Impressions</div>
                        </div>
                        <div class="stat">
                            <div class="value">${formatNumber(campaign.clicks)}</div>
                            <div class="label">Clicks</div>
                        </div>
                    `;
                }
                
                item.innerHTML = `
                    <div class="campaign-info">
                        <div class="campaign-type ${campaign.campaign_type}">
                            <i class="${icon}"></i> ${typeLabel}
                        </div>
                        <h4>${campaign.name}</h4>
                        <div class="campaign-meta">
                            <span>${formatDate(campaign.start_date)} - ${formatDate(campaign.end_date)}</span>
                            <span class="status-badge ${campaign.status}">${campaign.status.charAt(0).toUpperCase() + campaign.status.slice(1)}</span>
                        </div>
                    </div>
                    <div class="campaign-stats">
                        ${statsHtml}
                        <div class="stat">
                            <div class="value">${revenue}</div>
                            <div class="label">Revenue</div>
                        </div>
                    </div>
                    <div class="campaign-actions">
                        <button class="action-btn view" data-id="${campaign.campaign_id}">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </div>
                `;
                
                elements.topCampaignsList.appendChild(item);
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('.top-campaign-item .action-btn.view').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const campaignId = e.target.closest('button').dataset.id;
                    await showCampaignDetails(campaignId);
                });
            });
        }
    
        // Duplicate campaign
        async function duplicateCampaign(id) {
            if (confirm('Are you sure you want to duplicate this campaign?')) {
                try {
                    const response = await fetch(API_ENDPOINTS.CAMPAIGN_DETAILS(id));
                    if (!response.ok) {
                        throw new Error('Failed to fetch campaign details');
                    }
                    
                    const originalCampaign = await response.json();
                    
                    // Create a copy with "Copy of" prefix and draft status
                    const campaignCopy = {
                        ...originalCampaign,
                        name: `Copy of ${originalCampaign.name}`,
                        status: 'draft',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    delete campaignCopy.campaign_id; // Let the backend generate a new ID
                    
                    // Save the duplicate to API
                    const saveResponse = await fetch(API_ENDPOINTS.CAMPAIGNS, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(campaignCopy)
                    });
                    
                    if (!saveResponse.ok) {
                        throw new Error('Failed to save duplicate campaign');
                    }
                    
                    showSuccess('Campaign duplicated successfully!');
                    refreshCampaigns();
                } catch (error) {
                    console.error('Error duplicating campaign:', error);
                    showError('Failed to duplicate campaign. Please try again.');
                }
            }
        }
    
        // Toggle sidebar
        function toggleSidebar() {
            elements.sidebar.classList.toggle('collapsed');
        }
    
        // Helper functions for formatting
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '-';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return new Intl.NumberFormat('en-US').format(num);
        }
        
        function formatPercentage(num) {
            if (num === null || num === undefined) return '-';
            return `${num.toFixed(2)}%`;
        }
        
        function getCampaignTypeIcon(type) {
            switch(type) {
                case 'email': return 'fas fa-envelope';
                case 'social_media': return 'fas fa-share-alt';
                case 'in_app_ad': return 'fas fa-ad';
                default: return 'fas fa-bullhorn';
            }
        }
        
        function getCampaignTypeLabel(type) {
            switch(type) {
                case 'email': return 'Email';
                case 'social_media': return 'Social';
                case 'in_app_ad': return 'In-App Ad';
                default: return type;
            }
        }
    
        // Get paginated campaigns
        function getPaginatedCampaigns(campaigns, page, perPage) {
            const startIndex = (page - 1) * perPage;
            const endIndex = startIndex + perPage;
            return campaigns.slice(startIndex, endIndex);
        }
    
        // Render pagination
        function renderPagination(campaigns, page, perPage) {
            const totalPages = Math.ceil(campaigns.length / perPage);
            const paginationContainers = document.querySelectorAll('.pagination');
            
            paginationContainers.forEach(container => {
                container.innerHTML = '';
                
                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.className = 'pagination-btn';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevBtn.disabled = page === 1;
                prevBtn.addEventListener('click', () => {
                    currentPage = page - 1;
                    refreshCampaigns();
                });
                container.appendChild(prevBtn);
                
                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === page ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => {
                        currentPage = i;
                        refreshCampaigns();
                    });
                    container.appendChild(pageBtn);
                }
                
                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.className = 'pagination-btn';
                nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextBtn.disabled = page === totalPages;
                nextBtn.addEventListener('click', () => {
                    currentPage = page + 1;
                    refreshCampaigns();
                });
                container.appendChild(nextBtn);
            });
        }
    
        // Show success message
        function showSuccess(message) {
            // In a real app, you'd show this in a nice success toast/notification
            console.log(message);
            alert(message);
        }
        
        // Show error message
        function showError(message) {
            // In a real app, you'd show this in a nice error toast/notification
            console.error(message);
            alert(message);
        }
    
        // Initialize the application
        init();
    });</script>
</body>
</html>